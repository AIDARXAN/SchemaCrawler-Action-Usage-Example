name: SchemaCrawler Job to Lint Database Schema

on: [push]

jobs:
  schemacrawler-job:
    runs-on: ubuntu-latest

    name: SchemaCrawler Job to Lint Database Schema
    steps:

      - id: checkout
        name: Checkout repository
        uses: actions/checkout@v2

      - id: schemacrawler
        name: Run SchemaCrawler Action with specified command-line
        uses: schemacrawler/SchemaCrawler-Action@v16.11.4
        with:
          entrypoint: /schemacrawler.sh
          args: --server=sqlite --database=schemacrawler.sqlite --user:env USER --password:env PASSWORD --info-level=standard --command=lint --linter-configs ./.github/schemacrawler/schemacrawler-linter-configs.xml --lint-dispatch=terminate_system --output-file lint-report.txt
        env:
          USER: user-possibly-from-secrets
          PASSWORD: password-possibly-from-secrets

      - id: checkin
        name: Checkin lint report created from the SchemaCrawler Action
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git config pull.rebase true
          git add lint-report.txt
          git commit -m "SchemaCrawler lint report generated from GitHub action"
          git pull
          git push

      - id: check-success
        name: Fail the entire job if SchemaCrawler found any database lints
        run: |
          [ ${{ steps.schemacrawler.outputs.exit_status }} -eq 0 ] && echo "SchemaCrawler run succeeded" || exit ${{ steps.schemacrawler.outputs.exit_status }}

